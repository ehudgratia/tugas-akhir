---
title: ANALISIS PREDIKSI STUNTING PADA BALITA MENGGUNAKAN MACHINE LEARNING DENGAN   FAKTOR
  SOSIOEKONOMI
author: "Andre Daniel Sitinjak & Ehud Gratia Manullang"
date: "2025-04-12"
output: html_document
---

# Install Packages
```{r}
# Library yang berisi kumpulan packages untuk analisis data
library(tidyverse)
# library untuk manipulasi data
library(dplyr)
# library untuk manipulasi data tanggal
library(lubridate)
# library untuk menampilkan hasil statistik deskriptif
library(summarytools)
# library untuk visualisasi data
library (ggplot2)
#Mengabungkan visualisasi
library(gridExtra)
# library untuk membaca data dari file Excel (.xlsx)
library(readxl)
library(caret)
#PCA
library(FactoMineR)
#visualisasi PCA
library(factoextra)
#Correlation Matrix
library(corrplot)
# Visualisasi Correlation Matrix
library(ggcorrplot)
library(ranger)
library(randomForest)
library(pROC)
library(boot)
library(caTools)
library(e1071)
library(reshape2)
library(iml)
library(mlr) 
```
# 1. Obtain
## a. Import Dataset
```{r}
stunting <- read_excel("Dataset/stunting.xlsx")
stunting
```
# 2. Scrup Data
## a. Melihat struktur Data
```{r}
#Menampilkan struktur data
glimpse(stunting)
```
## b. Mengkonversi data ke tipe numerik
```{r}
# Melakukan Kelas Biner Terhadap Variabel Kategorial
data_transform <- stunting %>%
  mutate(umur_balita = case_when(umur_balita == "0-23 bulan" ~ 0, umur_balita == "0-59 bulan" ~ 1,),
    tinggi_balita = case_when(tinggi_balita == "Sangat Pendek" ~ 0, tinggi_balita == "Pendek" ~ 1,),
    status_gizi = case_when(status_gizi == "Gizi Buruk" ~ 0, status_gizi == "Gizi Kurang" ~ 1,),
    daerah = case_when(daerah == "Perkotaan" ~ 0, daerah == "Perdesaan" ~ 1,),
    jenis_gdp = case_when(jenis_gdp == "Harga berlaku" ~ 0, jenis_gdp == "Harga konstan 2010" ~ 1,),
    status_idm = case_when(status_idm == "Sangat Tertinggal" ~ 0, status_idm == "Tertinggal" ~ 1,
      status_idm == "Berkembang" ~ 2, status_idm == "Maju" ~ 3, status_idm == "Mandiri" ~ 4,))

glimpse(data_transform)
```
## c. Menghapus data kosong (missing value)
```{r}
# Menampilkan jumlah data missing value
colSums(is.na(data_transform))
```
Dari beberapa variabel, terdapat 6 variabel yang memiliki nilai kosong (missing value) yaitu jumlah_balita, persentase_stunting, idm,
status_idm memiliki 2048 missing value. Persentase missing value terhadap total data sebesar 3%. kemudian pada variabel 
persentase_tinggi_balita sebanyak 128 missing value, Persentase missing value terhadap total data sebesar 0,002%. lalu variabel
persentase_penduduk_miskin sebanyak 1024 missing value, Persentase missing value terhadap total data sebesar 0,01%. Yang dapat disimpulkan
jika missing value di bawah 10% maka data akan di hapus.
```{r}
# Hapus data NA's
data_clean <- na.omit(data_transform)
colSums(is.na(data_clean))
```

# 3. Explore Data Analysis (EDA)
## a.Menampilkan hasil statistik deskriptif
```{r}
#Melakukan analisis deskripsi
descr(data_clean)
```
## c. Visualisasi Distribusi
```{r}
# Histogram - Distribusi jumlah balita
p1 <- ggplot(data_clean, aes(x = jumlah_balita)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Jumlah Balita",
       x = "Jumlah Balita",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi jumlah balita
p2 <- ggplot(data_clean, aes(x = jumlah_balita)) +
  geom_boxplot() +
  labs(title = "Boxplot Jumlah Balita",
       x = "Jumlah Balita",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$jumlah_balita <- log1p(data_clean$jumlah_balita)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p3 <- ggplot(data_clean, aes(x = jumlah_balita)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Jumlah Balita\n(Log Transformasi)",
       x = "Log(Jumlah Balita)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p4 <- ggplot(data_clean, aes(x = jumlah_balita)) +
  geom_boxplot() +
  labs(title = "Boxplot Jumlah Balita\n(Log Transformasi)",
       x = "Log(Jumlah Balita)",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p1, p2, ncol = 2)
grid.arrange(p3, p4, ncol = 2)
```
```{r}
# Histogram - Distribusi Perentase Tinggi Balita
p5 <- ggplot(data_clean, aes(x = persentase_tinggi_balita)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data\nPersentase Tinggi Balita",
       x = "Persentase Tinggi Balita",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi Persentase Tinggi Balita
p6 <- ggplot(data_clean, aes(x = persentase_tinggi_balita)) +
  geom_boxplot() +
  labs(title = "Boxplot Persentase Tinggi Balita",
       x = "Persentase Tinggi Balita",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$persentase_tinggi_balita <- log1p(data_clean$persentase_tinggi_balita)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p7 <- ggplot(data_clean, aes(x = persentase_tinggi_balita)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data\nPersentase Tinggi Balita\n(Log Transformasi)",
       x = "Log(Persentase Tinggi Balita)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p8 <- ggplot(data_clean, aes(x = persentase_tinggi_balita)) +
  geom_boxplot() +
  labs(title = "Boxplot\nPersentase Tinggi Balita\n(Log Transformasi)",
       x = "Log(Persentase Tinggi Balita)",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p5, p6, ncol = 2)
grid.arrange(p7, p8, ncol = 2)
```
```{r}
# Histogram - Distribusi Perentase Gizi
p9 <- ggplot(data_clean, aes(x = persentase_gizi)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Persentase Gizi",
       x = "Persentase Gizi",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi Persentase Gizi
p10 <- ggplot(data_clean, aes(x = persentase_gizi)) +
  geom_boxplot() +
  labs(title = "Boxplot Persentase Gizi",
       x = "Persentase Gizi",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$persentase_gizi <- log1p(data_clean$persentase_gizi)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p11 <- ggplot(data_clean, aes(x = persentase_gizi)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data\nPersentase Gizi\n(Log Transformasi)",
       x = "Log(Persentase Gizi)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p12 <- ggplot(data_clean, aes(x = persentase_gizi)) +
  geom_boxplot() +
  labs(title = "Boxplot\nPersentase Gizi\n(Log Transformasi)",
       x = "Log(Persentase Gizi)",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p9, p10, ncol = 2)
grid.arrange(p11, p12, ncol = 2)
```
```{r}
# Histogram - Distribusi Perentase Penduduk Miskin
p13 <- ggplot(data_clean, aes(x = persentase_penduduk_miskin)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data\nPersentase Penduduk Miskin",
       x = "Persentase Penduduk Miskin",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi Persentase Penduduk Miskin
p14 <- ggplot(data_clean, aes(x = persentase_penduduk_miskin)) +
  geom_boxplot() +
  labs(title = "Boxplot\nPersentase Penduduk Miskin",
       x = "Persentase Penduduk Miskin",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$persentase_penduduk_miskin <- log1p(data_clean$persentase_penduduk_miskin)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p15 <- ggplot(data_clean, aes(x = persentase_penduduk_miskin)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data\nPersentase Penduduk Miskin\n(Log Transformasi)",
       x = "Log(Persentase Penduduk Miskin)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p16 <- ggplot(data_clean, aes(x = persentase_penduduk_miskin)) +
  geom_boxplot() +
  labs(title = "Boxplot\nPersentase Penduduk Miskin\n(Log Transformasi)",
       x = "Log(Persentase Penduduk Miskin)",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p13, p14, ncol = 2)
grid.arrange(p15, p16, ncol = 2)
```
```{r}
# Histogram - Distribusi IPM
p17 <- ggplot(data_clean, aes(x = ipm)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data IPM",
       x = "IPM",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi IPM
p18 <- ggplot(data_clean, aes(x = ipm)) +
  geom_boxplot() +
  labs(title = "Boxplot IPM",
       x = "IPM",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$ipm <- log1p(data_clean$ipm)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p19 <- ggplot(data_clean, aes(x = ipm)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data IPM \n(Log Transformasi)",
       x = "Log(IPM)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p20 <- ggplot(data_clean, aes(x = ipm)) +
  geom_boxplot() +
  labs(title = "Boxplot IPM \n(Log Transformasi)",
       x = "Log(IPM)",
       y = "Frekuensi") +
  theme_minimal()

##Deteksi Outlier pada Jumlah Balita
Q1_ipm <- quantile(data_clean$ipm, 0.25)
Q3_ipm <- quantile(data_clean$ipm, 0.75)
IQR_ipm <- Q3_ipm - Q1_ipm

lower_bound_ipm <- Q1_ipm - 1.5 * IQR_ipm
upper_bound_ipm <- Q3_ipm + 1.5 * IQR_ipm

repeat {
  Q1_ipm <- quantile(data_clean$ipm, 0.25, na.rm = TRUE)
  Q3_ipm <- quantile(data_clean$ipm, 0.75, na.rm = TRUE)
  IQR_ipm <- Q3_ipm - Q1_ipm
  lower_bound_ipm <- Q1_ipm - 1.5 * IQR_ipm
  upper_bound_ipm <- Q3_ipm + 1.5 * IQR_ipm
  
  # Simpan jumlah data sebelum filtering
  n_before <- nrow(data_clean)
  
  # Hapus outlier langsung dari data_clean tanpa membuat dataset baru
  data_clean <- data_clean[data_clean$ipm >= lower_bound_ipm & data_clean$ipm <= upper_bound_ipm, ]
  
  # Cek jika jumlah data tidak berubah, maka keluar dari loop
  if (nrow(data_clean) == n_before) break
}

##Menghapus outlier
data_clean <- data_clean[data_clean$ipm >= lower_bound_ipm & data_clean$ipm <= upper_bound_ipm, ]

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p21 <- ggplot(data_clean, aes(x = ipm)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data IPM\n(Interquartile Range (IQR))",
       x = "IPM",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p22 <- ggplot(data_clean, aes(x = ipm)) +
  geom_boxplot() +
  labs(title = "Boxplot IPM\n(Interquartile Range (IQR))",
       x = "IPM",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p17, p18, ncol = 2)
grid.arrange(p19, p20, ncol = 2)
grid.arrange(p21, p22, ncol = 2)
```
```{r}
# Histogram - Distribusi Nilai GDP
p23 <- ggplot(data_clean, aes(x = nilai_gdp)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Nilai GDP",
       x = "Nilai GDP",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi Nilai GDP
p24 <- ggplot(data_clean, aes(x = nilai_gdp)) +
  geom_boxplot() +
  labs(title = "Boxplot Nilai GDP",
       x = "Nilai GDP",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$nilai_gdp <- log1p(data_clean$nilai_gdp)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p25 <- ggplot(data_clean, aes(x = nilai_gdp)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data GDP\n(Log Transformasi)",
       x = "Log(GDP)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p26 <- ggplot(data_clean, aes(x = nilai_gdp)) +
  geom_boxplot() +
  labs(title = "Boxplot GDP\n(Log Transformasi)",
       x = "Log(GDP)",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p23, p24, ncol = 2)
grid.arrange(p25, p26, ncol = 2)
```
```{r}
# Histogram - Distribusi Upah
p27 <- ggplot(data_clean, aes(x = upah)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Upah",
       x = "Upah",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi Upah
p28 <- ggplot(data_clean, aes(x = upah)) +
  geom_boxplot() +
  labs(title = "Boxplot Upah",
       x = "Upah",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p27, p28, ncol = 2)
```
```{r}
# Histogram - Distribusi IDM
p29 <- ggplot(data_clean, aes(x = idm)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data IDM",
       x = "IDM",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi IDM
p30 <- ggplot(data_clean, aes(x = idm)) +
  geom_boxplot() +
  labs(title = "Boxplot IDM",
       x = "IDM",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$idm <- log1p(data_clean$idm)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p31 <- ggplot(data_clean, aes(x = idm)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data IDM\n(Log Transformasi)",
       x = "Log(IDM)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p32 <- ggplot(data_clean, aes(x = idm)) +
  geom_boxplot() +
  labs(title = "Boxplot IDM\n(Log Transformasi)",
       x = "Log(IDM)",
       y = "Frekuensi") +
  theme_minimal()

grid.arrange(p29, p30, ncol = 2)
grid.arrange(p31, p32, ncol = 2)
```
```{r}
# Histogram - Distribusi Persentase Stunting
p33 <- ggplot(data_clean, aes(x = persentase_stunting)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Persentase Stunting",
       x = "Persentase Stunting",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Distribusi IDM
p34 <- ggplot(data_clean, aes(x = persentase_stunting)) +
  geom_boxplot() +
  labs(title = "Boxplot Persentase Stunting",
       x = "Persentase Stunting",
       y = "Frekuensi") +
  theme_minimal()

# Log Transformasi untuk membuat distribusi lebih seimbang
data_clean$persentase_stunting <- log1p(data_clean$persentase_stunting)  # log1p untuk menangani nol

# Histogram - Visualisasi Distribusi Data setelah Transformasi Log
p35 <- ggplot(data_clean, aes(x = persentase_stunting)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Persentase Stunting\n(Log Transformasi)",
       x = "Log(Persentase Stunting)",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p36 <- ggplot(data_clean, aes(x = persentase_stunting)) +
  geom_boxplot() +
  labs(title = "Boxplot Persentase Stunting\n(Log Transformasi)",
       x = "Log(Persentase Stunting)",
       y = "Frekuensi") +
  theme_minimal()

##Deteksi Outlier pada Persentase Stunting
Q1_stunting <- quantile(data_clean$persentase_stunting, 0.25)
Q3_stunting <- quantile(data_clean$persentase_stunting, 0.75)
IQR_stunting <- Q3_stunting - Q1_stunting

lower_bound_stunting <- Q1_stunting - 1.5 * IQR_stunting
upper_bound_stunting <- Q3_stunting + 1.5 * IQR_stunting

repeat {
  Q1_stunting <- quantile(data_clean$persentase_stunting, 0.25, na.rm = TRUE)
  Q3_stunting <- quantile(data_clean$persentase_stunting, 0.75, na.rm = TRUE)
  IQR_stunting <- Q3_stunting - Q1_stunting
  lower_bound_stunting <- Q1_stunting - 1.5 * IQR_stunting
  upper_bound_stunting <- Q3_stunting + 1.5 * IQR_stunting
  
  # Simpan jumlah data sebelum filtering
  n_before <- nrow(data_clean)
  
  # Hapus outlier langsung dari data_clean tanpa membuat dataset baru
  data_clean <- data_clean[data_clean$persentase_stunting >= lower_bound_stunting & data_clean$persentase_stunting <= upper_bound_stunting, ]
  
  # Cek jika jumlah data tidak berubah, maka keluar dari loop
  if (nrow(data_clean) == n_before) break
}

##Menghapus outlier
data_clean <- data_clean[data_clean$persentase_stunting >= lower_bound_stunting & data_clean$persentase_stunting <= upper_bound_stunting, ]

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p37 <- ggplot(data_clean, aes(x = persentase_stunting)) +
  geom_histogram(bins = 30, fill = "blue", color = "black", alpha = 0.6) +
  labs(title = "Distribusi Data Persentase Stunting\n(Interquartile Range (IQR))",
       x = "Persentase Stunting",
       y = "Frekuensi") +
  theme_minimal()

# Boxplot - Visualisasi Distribusi Data setelah Transformasi Log
p38 <- ggplot(data_clean, aes(x = persentase_stunting)) +
  geom_boxplot() +
  labs(title = "Boxplot Persentase Stunting\n(Interquartile Range (IQR))",
       x = "Persentase Stunting",
       y = "Frekuensi") +
  theme_minimal()


grid.arrange(p33, p34, ncol = 2)
grid.arrange(p35, p36, ncol = 2)
grid.arrange(p37, p38, ncol = 2)
```
# 4. Model
## a. Pembagian Data
```{r}
set.seed(123) 
data_index <- createDataPartition(data_clean$persentase_stunting, p = 0.7, list = FALSE)
data_train <- data_clean[data_index, ]
data_test <- data_clean[-data_index, ]
data_train
data_test
```
## b. Memisahkan variabel target dengan fitur
```{r}
# Hitung median dari data training
median_train <- median(data_train$persentase_stunting)
data_train <- data_train %>% 
  mutate(persentase_stunting = ifelse(persentase_stunting > median_train, 1, 0))

# Terapkan median yang sama ke data test
data_test <- data_test %>% 
  mutate(persentase_stunting = ifelse(persentase_stunting > median_train, 1, 0))

# Mengubah variabel target menjadi faktor
data_train$persentase_stunting <- as.factor(data_train$persentase_stunting)
data_test$persentase_stunting <- as.factor(data_test$persentase_stunting)

# Pisahkan target dan fitur di data training
train_target <- data_train$persentase_stunting
train_features <- data_train %>% select(-persentase_stunting)

# Pisahkan target dan fitur di data test
test_target <- data_test$persentase_stunting
test_features <- data_test %>% select(-persentase_stunting)
```
## c. Memilih Fitur Terbaik 
```{r}
# Correlation Matrix
## Pilih hanya variabel numerik
train_features <- train_features %>%
  select(where(is.numeric)) %>% 
  select(-tahun)  # Exclude the year column

## Hitung matriks korelasi
cor_matrix <- cor(train_features, use = "pairwise.complete.obs", method = "pearson")

## Temukan fitur yang memiliki korelasi tinggi (|r| > 0.75)
high_cor <- findCorrelation(cor_matrix, cutoff = 0.75, names = FALSE)

## Hapus fitur yang memiliki korelasi tinggi
train_features <- train_features %>% select(-all_of(names(train_features)[high_cor]))

## Hitung kembali matriks korelasi setelah penghapusan
cor_matrix_after <- cor(train_features, use = "pairwise.complete.obs", method = "pearson")

ggcorrplot(cor_matrix, 
           type = "lower",        # Hanya setengah bagian bawah
           lab = TRUE,            # Menampilkan nilai korelasi
           lab_size = 3,          # Ukuran teks
           colors = c("red", "white", "blue"),  # Skala warna (Merah - Putih - Biru)
           title = "Matriks Korelasi",
           show.legend = TRUE, 
           ggtheme = ggplot2::theme_minimal())

## Plot Setelah Penghapusan (Untuk Perbandingan)
ggcorrplot(cor_matrix_after, 
           type = "lower", 
           lab = TRUE, 
           lab_size = 3, 
           colors = c("red", "white", "blue"), 
           title = "Matriks Korelasi Setelah Penghapusan",
           show.legend = TRUE, 
           ggtheme = ggplot2::theme_minimal())

```


```{r}
# Recursive Feature Elimination (RFE)
set.seed(123)
# Kontrol untuk RFE
control <- rfeControl(functions = rfFuncs,
                      method = "cv",
                      number = 5)
# Jalankan Recursive Feature Elimination
rfe_result <- rfe(train_features, train_target, sizes = c(1:10), rfeControl = control)
rfe_result
```
```{r}
# Buat dataframe hasil RFE
feature_ranking <- data.frame(
  Feature = rownames(varImp(rfe_result)),
  Importance = varImp(rfe_result)$Overall
)

# Plot ranking fitur
ggplot(feature_ranking, aes(x = reorder(Feature, Importance), y = Importance)) +
  geom_bar(stat = "identity", fill = "blue") + 
  coord_flip() +
  labs(title = "Feature Ranking dari RFE",
       x = "Fitur", 
       y = "Pentingnya Fitur") +
  theme_minimal()
  
```
```{r}
## Mengambil nama fitur terbaik
manual_selected <- c("ipm", "upah", "jumlah_balita")

## Data frame hanya dengan fitur yang dipilih
train_features <- train_features[, manual_selected]
test_features <- test_features[, manual_selected]
```

```{r}
# Pre-Processing Data
## Scaling
preproc <- preProcess(train_features, method = c("center", "scale"))

## Normalisasi
train_scaled <- predict(preproc, train_features)
test_scaled <- predict(preproc, test_features)

## Cek ringkasan data setelah standarisasi
summary(train_scaled)
```
```{r}
## Jalankan PCA dengan data yang telah distandarisasi
pca_model <- PCA(train_scaled, graph = FALSE)

## Transform data test
test_pca <- predict(pca_model, newdata = test_scaled)

## Lihat ringkasan PCA
summary(pca_model)
```
```{r}
## Melacak kontribusi variabel
pca_model$var$contrib
```
```{r}
## Jumlah komponen utama yang optimal untuk analisis
fviz_eig(pca_model, addlabels = TRUE, ylim = c(0, 100))
```
```{r}
## Membuat peta factor untuk kontribusi variabel
fviz_pca_var(pca_model, col.var = "contrib", gradient.cols = c("#002bbb", "#bb2e00"), repel = TRUE)
```
```{r}
## Visualisasi kontribusi dari variabel
fviz_contrib(pca_model, choice = "var", axes = 1, top = 5)
```
Keterangan: Garis merah mengacu pada persentase yang diharapkan jika distribusi tersebut merata
```{r}
# Visualisasi untuk semua hubungan antar variabel
fviz_pca_biplot(pca_model,
                repel = TRUE,          # Menghindari label saling tumpang tindih
                label = "var",         # Menampilkan hanya nama variabel
                col.var = "blue",      # Warna vektor variabel
                col.ind = "black",     # Warna titik individu
                geom.ind = "point",    # Tampilkan individu sebagai titik
                addEllipses = FALSE    # Tidak menampilkan ellips
)
```
# d. Menggabungkan variabel feature dengan variabel target
```{r}
# Menggabungkan variabel feature dengan variabel target
train_final <- cbind(train_features, stunting = train_target)
test_final <- cbind(test_features, stunting = test_target)

# Menggabungkan variabel feature dengan Target dari PCA
train_final1 <- cbind(as.data.frame(pca_model$ind$coord), stunting = data_train$persentase_stunting)
test_final1 <- cbind(as.data.frame(test_pca$coord), stunting = data_test$persentase_stunting)
```
```{r}
#Visualisasi Distrubusi Stunting
ggplot(train_final, aes(x = stunting)) +
  geom_bar(fill = "blue") +
  labs(title = "Distribusi Data Stunting",
       x = "Stunting",
       y = "Frekuensi") +
  theme_minimal()
```
```{r}
table(train_final$stunting)
```
```{r}
# Memastikan target adalah factor
train_final$stunting <- as.factor(train_final$stunting)
test_final$stunting <- as.factor(test_final$stunting)
glimpse(train_final)
glimpse(test_final)
```
# e. Membangun model RF
```{r}
# Model default
set.seed(123)
rf_model1 <- randomForest(stunting ~ ., data = train_final,
                          ntree = 200,
                          mtry = floor(sqrt(ncol(train_final)-1)),
                          nodesize = 10,
                          maxnodes = 20,
                          importance = TRUE)

# Prediksi & evaluasi
pred_rf1 <- predict(rf_model1, test_final)
conf_matrix_rf1 <- confusionMatrix(pred_rf1, test_final$stunting)

## hasil
print(rf_model1)
print(conf_matrix_rf1)

# Ekstrak confusion matrix dari caret
cm_rfmodel1 <- as.data.frame(conf_matrix_rf1$table)

# Ganti nama kolom supaya konsisten
colnames(cm_rfmodel1) <- c("Prediction", "Reference", "Freq")

# Plot pakai ggplot2
ggplot(cm_rfmodel1, aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Freq), size = 6) +
  scale_fill_gradient(low = "white", high = "skyblue") +
  labs(
    title = "Confusion Matrix - rf_model1",
    x = "Actual (Reference)",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal() +
  coord_fixed()
```
```{r}
# Model 2: Lebih teratur dengan regularisasi
set.seed(123)
rf_model2 <- randomForest(stunting ~ ., data = train_final, 
                         ntree = 300,  # Sedikit mengurangi jumlah pohon
                         mtry = floor(sqrt(ncol(train_final)-1)),
                         nodesize = 15,  # Ukuran node lebih besar
                         maxnodes = 30,  # Batas node lebih longgar
                         sampsize = 0.7*nrow(train_final), # Subsample data
                         importance = TRUE)

# Prediksi & evaluasi
pred_rf2 <- predict(rf_model2, test_final)
conf_matrix_rf2 <- confusionMatrix(pred_rf2, test_final$stunting)

## hasil
print(rf_model2)
print(conf_matrix_rf2)

# Ekstrak confusion matrix dari caret
cm_rfmodel2 <- as.data.frame(conf_matrix_rf2$table)

# Ganti nama kolom supaya konsisten
colnames(cm_rfmodel2) <- c("Prediction", "Reference", "Freq")

# Plot pakai ggplot2
ggplot(cm_rfmodel2, aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Freq), size = 6) +
  scale_fill_gradient(low = "white", high = "skyblue") +
  labs(
    title = "Confusion Matrix - rf_model2",
    x = "Actual (Reference)",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal() +
  coord_fixed()
```
```{r}
# Model 3: Konfigurasi sangat konservatif
set.seed(123)
rf_model3 <- randomForest(stunting ~ ., data = train_final, 
                         ntree = 150, 
                         mtry = max(floor(ncol(train_final)/3), 3), 
                         nodesize = 25, 
                         maxnodes = 15,
                         strata = train_final$stunting,  # Stratified sampling
                         sampsize = c("0" = 500, "1" = 500),  # Balanced subsample
                         importance = TRUE)

# Prediksi & evaluasi
pred_rf3 <- predict(rf_model3, test_final)
conf_matrix_rf3 <- confusionMatrix(pred_rf3, test_final$stunting)

## hasil
print(rf_model3)
print(conf_matrix_rf3)

# Ekstrak confusion matrix dari caret
cm_rfmodel3 <- as.data.frame(conf_matrix_rf3$table)

# Ganti nama kolom supaya konsisten
colnames(cm_rfmodel3) <- c("Prediction", "Reference", "Freq")

# Plot pakai ggplot2
ggplot(cm_rfmodel3, aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Freq), size = 6) +
  scale_fill_gradient(low = "white", high = "skyblue") +
  labs(
    title = "Confusion Matrix - rf_model3",
    x = "Actual (Reference)",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal() +
  coord_fixed()
```

## f. Membangun Model SVM
```{r}
# Model default
svm_model1 <-svm(stunting ~., data =train_final,
                 kernel='radial',
                 cost = 100,
                 gamma = 0.1)

# Prediksi dan Evaluasi
pred_svm1 <- predict(svm_model1, test_final)
conf_matrix_svm1 <- confusionMatrix(pred_svm1, test_final$stunting)

# Hasil model svm
print(svm_model1)
print(conf_matrix_svm1)

# Ekstrak confusion matrix dari caret
cm_svmmodel1 <- as.data.frame(conf_matrix_svm1$table)

# Ganti nama kolom supaya konsisten
colnames(cm_svmmodel1) <- c("Prediction", "Reference", "Freq")

# Plot pakai ggplot2
ggplot(cm_svmmodel1, aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Freq), size = 6) +
  scale_fill_gradient(low = "white", high = "skyblue") +
  labs(
    title = "Confusion Matrix - svm_model1",
    x = "Actual (Reference)",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal() +
  coord_fixed()
```
```{r}
# Model 2: Kernel radial dengan regularisasi lebih ketat
svm_model2 <- svm(stunting ~., data = train_final, 
                 kernel = 'radial',
                 cost = 10,  # Regularisasi lebih kuat
                 gamma = 0.01,  # Pengaruh titik data lebih kecil
                 class.weights = c("0" = 1, "1" = 2))  # Menangani ketidakseimbangan kelas

# Prediksi dan Evaluasi
pred_svm2 <- predict(svm_model2, test_final)
conf_matrix_svm2 <- confusionMatrix(pred_svm2, test_final$stunting)

# Hasil model svm
print(svm_model2)
print(conf_matrix_svm2)

# Ekstrak confusion matrix dari caret
cm_svmmodel2 <- as.data.frame(conf_matrix_svm2$table)

# Ganti nama kolom supaya konsisten
colnames(cm_svmmodel2) <- c("Prediction", "Reference", "Freq")

# Plot pakai ggplot2
ggplot(cm_svmmodel2, aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Freq), size = 6) +
  scale_fill_gradient(low = "white", high = "skyblue") +
  labs(
    title = "Confusion Matrix - svm_model2",
    x = "Actual (Reference)",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal() +
  coord_fixed()
```
```{r}
# Model 3: Kernel polynomial dengan regularisasi
svm_model3 <- svm(stunting ~., data = train_final, 
                 kernel = 'polynomial', 
                 cost = 0.5,  # Margin lebih lebar
                 scale = TRUE,  # Scaling otomatis
                 class.weights = c("0" = 1, "1" = 1.5))  # Bobot kelas

# Prediksi dan Evaluasi
pred_svm3 <- predict(svm_model3, test_final)
conf_matrix_svm3 <- confusionMatrix(pred_svm3, test_final$stunting)

# Hasil model svm
print(svm_model3)
print(conf_matrix_svm3)

# Ekstrak confusion matrix dari caret
cm_svmmodel3 <- as.data.frame(conf_matrix_svm3$table)

# Ganti nama kolom supaya konsisten
colnames(cm_svmmodel3) <- c("Prediction", "Reference", "Freq")

# Plot pakai ggplot2
ggplot(cm_svmmodel3, aes(x = Reference, y = Prediction, fill = Freq)) +
  geom_tile(color = "black") +
  geom_text(aes(label = Freq), size = 6) +
  scale_fill_gradient(low = "white", high = "skyblue") +
  labs(
    title = "Confusion Matrix - svm_model3",
    x = "Actual (Reference)",
    y = "Predicted",
    fill = "Count"
  ) +
  theme_minimal() +
  coord_fixed()

```


# 5. Interpret
```{r}
# Extract Metrics
metrics_rf1 <- conf_matrix_rf1$byClass[c("Precision", "Recall", "F1")]
accuracy_rf1 <- conf_matrix_rf1$overall["Accuracy"]

metrics_svm1 <- conf_matrix_svm1$byClass[c("Precision", "Recall", "F1")]
accuracy_svm1 <- conf_matrix_svm1$overall["Accuracy"]

# satukan datata
metrics_df1 <- tibble(
  Metric = c("Accuracy", "Recall", "Precision", "F1-score"),
  RF = c(accuracy_rf1, metrics_rf1),
  SVM = c(accuracy_svm1, metrics_svm1)
) %>%
  pivot_longer(cols = c(RF, SVM), names_to = "Model", values_to = "Value")

# Visualisasi
ggplot(metrics_df1, aes(x = Metric, y = Value, fill = Model)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_text(aes(label = round(Value, 3)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 3) +
  scale_fill_manual(values = c("RF" = "#1b9e77", "SVM" = "#d95f02")) +
  labs(title = "Perbandingan Kinerja Model rf_model1 vs svm_model1",
       y = "Nilai Metrik", x = "Metrik Evaluasi") +
  theme_minimal()
```
```{r}
# Extract Metrics
metrics_rf2 <- conf_matrix_rf2$byClass[c("Precision", "Recall", "F1")]
accuracy_rf2 <- conf_matrix_rf2$overall["Accuracy"]

metrics_svm2 <- conf_matrix_svm2$byClass[c("Precision", "Recall", "F1")]
accuracy_svm2 <- conf_matrix_svm2$overall["Accuracy"]

# satukan datata
metrics_df2 <- tibble(
  Metric = c("Accuracy", "Recall", "Precision", "F1-score"),
  RF = c(accuracy_rf2, metrics_rf2),
  SVM = c(accuracy_svm2, metrics_svm2)
) %>%
  pivot_longer(cols = c(RF, SVM), names_to = "Model", values_to = "Value")

# Visualisasi
ggplot(metrics_df2, aes(x = Metric, y = Value, fill = Model)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_text(aes(label = round(Value, 3)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 3) +
  scale_fill_manual(values = c("RF" = "#1b9e77", "SVM" = "#d95f02")) +
  labs(title = "Perbandingan Kinerja Model rf_model2 vs svm_model2",
       y = "Nilai Metrik", x = "Metrik Evaluasi") +
  theme_minimal()
```
```{r}
# Extract Metrics
metrics_rf3 <- conf_matrix_rf3$byClass[c("Precision", "Recall", "F1")]
accuracy_rf3 <- conf_matrix_rf3$overall["Accuracy"]

metrics_svm3 <- conf_matrix_svm3$byClass[c("Precision", "Recall", "F1")]
accuracy_svm3 <- conf_matrix_svm3$overall["Accuracy"]

# satukan datata
metrics_df3 <- tibble(
  Metric = c("Accuracy", "Recall", "Precision", "F1-score"),
  RF = c(accuracy_rf3, metrics_rf3),
  SVM = c(accuracy_svm3, metrics_svm3)
) %>%
  pivot_longer(cols = c(RF, SVM), names_to = "Model", values_to = "Value")

# Visualisasi
ggplot(metrics_df3, aes(x = Metric, y = Value, fill = Model)) +
  geom_col(position = position_dodge(width = 0.7), width = 0.6) +
  geom_text(aes(label = round(Value, 3)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 3) +
  scale_fill_manual(values = c("RF" = "#1b9e77", "SVM" = "#d95f02")) +
  labs(title = "Perbandingan Kinerja Model rf_model3 vs svm_model3",
       y = "Nilai Metrik", x = "Metrik Evaluasi") +
  theme_minimal()
```

```{r}
# Buat prediktor untuk model RF
predictor_rf1 <- Predictor$new(
  model = rf_model1,
  data = test_final[, -which(names(test_final) == "stunting")],
  y = test_final$stunting
)

# Hitung Permutation Importance
imp_rf1 <- FeatureImp$new(predictor_rf1, loss = "ce")

# Buat objek prediktor
predictor_svm1 <- Predictor$new(
  model = svm_model1,
  data = test_final[, -which(names(test_final) == "stunting")],  # semua fitur
  y = test_final$stunting
)

# Hitung feature importance dengan Permutation
imp_svm1 <- FeatureImp$new(predictor_svm1, loss = "ce")

# Ambil hasil importance dari model
df_rf1 <- as.data.frame(imp_rf1$results)
df_svm1 <- as.data.frame(imp_svm1$results)

# Contoh plot importance untuk Random Forest
p39 <- ggplot(df_rf1, aes(x = reorder(feature, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Permutation\nFeature Importance\nrf_model1",
       x = "Fitur",
       y = "Importance (Penurunan Akurasi)") +
  theme_minimal()

# Contoh plot importance untuk SVM
p40 <- ggplot(df_svm1, aes(x = reorder(feature, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Permutation\nFeature Importance\nsvm_model1",
       x = "Fitur",
       y = "Importance (Penurunan Akurasi)") +
  theme_minimal()

grid.arrange(p39, p40, ncol = 2)
```

```{r}
# Buat prediktor untuk model RF
predictor_rf2 <- Predictor$new(
  model = rf_model2,
  data = test_final[, -which(names(test_final) == "stunting")],
  y = test_final$stunting
)

# Hitung Permutation Importance
imp_rf2 <- FeatureImp$new(predictor_rf, loss = "ce")

# Buat objek prediktor
predictor_svm2 <- Predictor$new(
  model = svm_model2,
  data = test_final[, -which(names(test_final) == "stunting")],  # semua fitur
  y = test_final$stunting
)

# Hitung feature importance dengan Permutation
imp_svm2 <- FeatureImp$new(predictor_svm2, loss = "ce")

# Ambil hasil importance dari model
df_rf2 <- as.data.frame(imp_rf2$results)
df_svm2 <- as.data.frame(imp_svm2$results)

# Contoh plot importance untuk Random Forest
p41 <- ggplot(df_rf2, aes(x = reorder(feature, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Permutation\nFeature Importance\nrf_model2",
       x = "Fitur",
       y = "Importance (Penurunan Akurasi)") +
  theme_minimal()

# Contoh plot importance untuk SVM
p42 <- ggplot(df_svm2, aes(x = reorder(feature, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Permutation\nFeature Importance\nsvm_model2",
       x = "Fitur",
       y = "Importance (Penurunan Akurasi)") +
  theme_minimal()

grid.arrange(p41, p42, ncol = 2)
```

```{r}
# Buat prediktor untuk model RF
predictor_rf3 <- Predictor$new(
  model = rf_model3,
  data = test_final[, -which(names(test_final) == "stunting")],
  y = test_final$stunting
)

# Hitung Permutation Importance
imp_rf3 <- FeatureImp$new(predictor_rf3, loss = "ce")

# Buat objek prediktor
predictor_svm3 <- Predictor$new(
  model = svm_model3,
  data = test_final[, -which(names(test_final) == "stunting")],  # semua fitur
  y = test_final$stunting
)

# Hitung feature importance dengan Permutation
imp_svm3 <- FeatureImp$new(predictor_svm3, loss = "ce")

# Ambil hasil importance dari model
df_rf3 <- as.data.frame(imp_rf3$results)
df_svm3 <- as.data.frame(imp_svm3$results)

# Contoh plot importance untuk Random Forest
p43 <- ggplot(df_rf3, aes(x = reorder(feature, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Permutation\nFeature Importance\nrf_model3",
       x = "Fitur",
       y = "Importance (Penurunan Akurasi)") +
  theme_minimal()

# Contoh plot importance untuk SVM
p44 <- ggplot(df_svm2, aes(x = reorder(feature, importance), y = importance)) +
  geom_bar(stat = "identity", fill = "blue") +
  coord_flip() +
  labs(title = "Permutation\nFeature Importance\nsvm_model3",
       x = "Fitur",
       y = "Importance (Penurunan Akurasi)") +
  theme_minimal()

grid.arrange(p43, p44, ncol = 2)
```